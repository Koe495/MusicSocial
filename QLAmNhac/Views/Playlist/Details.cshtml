@using System.Linq
@model QLAmNhac.Models.Playlist

@{
    ViewBag.Title = Model.TenPlaylist;
    Layout = "~/Views/Shared/_Layout.cshtml"; // Đảm bảo có layout
}

<div class="container" style="margin-top: 40px; margin-bottom: 80px;">

    <!-- 1. Header Playlist -->
    <div class="row mb-5 align-items-end">
        <div class="col-md-3">
            @if (Model.Playlist_ChiTiet != null && Model.Playlist_ChiTiet.Count > 0)
            {
                // Lấy bài có ThuTu nhỏ nhất làm ảnh bìa
                var firstSong = Model.Playlist_ChiTiet.OrderBy(x => x.ThuTu).FirstOrDefault()?.BaiHat;
                if (firstSong != null)
                {
                    <img src="https://img.youtube.com/vi/@firstSong.LinkYoutube/hqdefault.jpg" class="playlist-header-img" alt="Playlist Cover" />
                }
                else
                {
                    <div class="playlist-empty-img"><i class="fa fa-music fa-4x"></i></div>
                }
            }
            else
            {
                <div class="playlist-empty-img"><i class="fa fa-music fa-4x"></i></div>
            }
        </div>

        <div class="col-md-9">
            <h6 style="color: #fff; text-transform: uppercase; font-weight: 700; font-size: 0.9rem;">Playlist</h6>
            <h1 style="color: white; font-weight: 900; font-size: 4.5em; margin: 10px 0 20px 0; line-height: 1;">@Model.TenPlaylist</h1>

            <p style="color: #bbb; font-size: 14px;">
                <span style="color: #fff; font-weight: bold;">@Model.NguoiDung.HoTen</span>
                @if (Model.Playlist_ChiTiet != null)
                {
                    <span>• @Model.Playlist_ChiTiet.Count bài hát</span>
                }
            </p>

            @if (Model.Playlist_ChiTiet != null && Model.Playlist_ChiTiet.Count > 0)
            {
                var playLink = Model.Playlist_ChiTiet.OrderBy(x => x.ThuTu).FirstOrDefault()?.MaBaiHat;

            }
        </div>
    </div>

    <!-- 2. Danh sách bài hát -->
    @if (Model.Playlist_ChiTiet != null && Model.Playlist_ChiTiet.Count > 0)
    {
        <div class="table-responsive">
            <table class="table custom-table">
                <thead>
                    <tr>
                        <th style="width: 40px;" class="text-center"></th> <!-- Cột Kéo thả -->
                        <th style="width: 40px;" class="text-center">#</th> <!-- Cột STT -->
                        <th>TIÊU ĐỀ</th>
                        <th style="width: 60px;"></th> <!-- Cột Xóa -->
                    </tr>
                </thead>
                <tbody id="sortable-playlist">
                    @{ int i = 1; }
                    @foreach (var item in Model.Playlist_ChiTiet.OrderBy(x => x.ThuTu))
                    {
                        <tr id="row-@item.MaBaiHat" data-song-id="@item.MaBaiHat" style="background-color: transparent;">
                            <!-- Nút Kéo Thả -->
                            <td class="text-center" style="vertical-align: middle;">
                                <i class="fa fa-bars drag-handle" title="Kéo để sắp xếp"></i>
                            </td>

                            <!-- STT: Thêm class 'stt-index' để JS cập nhật -->
                            <td class="text-center stt-index" style="vertical-align: middle; color: #999;">@i</td>

                            <!-- Thông tin bài hát -->
                            <td>
                                <div class="media align-items-center" style="padding-bottom: 0px; margin-bottom: 0px;">
                                    <div class="media-left mr-3">
                                        <img src="https://img.youtube.com/vi/@item.BaiHat.LinkYoutube/default.jpg" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;" />
                                    </div>
                                    <div class="media-body">
                                        <a href="@Url.Action("Details", "Songs", new { id = item.MaBaiHat })"
                                           target="_blank"
                                           rel="noopener noreferrer"
                                           style="color: white; font-weight: 500; text-decoration: none; font-size: 16px; display: block;">
                                            @item.BaiHat.TenBaiHat
                                        </a>
                                        <span style="font-size: 13px; color: #b3b3b3;">@item.BaiHat.NguoiTrinhBay</span>
                                    </div>
                                </div>
                            </td>

                            <!-- Nút Xóa -->
                            <td style="vertical-align: middle; text-align: right;">
                                <button class="btn-remove-song" onclick="removeSong(@Model.MaPlaylist, @item.MaBaiHat)" title="Xóa khỏi playlist">
                                    <i class="fa fa-times"></i>
                                </button>
                            </td>
                        </tr>
                        i++;
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="text-center" style="padding: 50px 0; color: #888;">
            <i class="fa fa-music mb-3" style="font-size: 50px; opacity: 0.5;"></i>
            <p>Playlist này chưa có bài hát nào.</p>
            <a href="@Url.Action("Index", "Songs")" class="btn btn-outline-light btn-sm" style="border-radius: 20px;">Tìm bài hát ngay</a>
        </div>
    }
</div>

@section scripts {
    <!-- Thư viện jQuery UI -->
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <script>
        $(document).ready(function() {
            // Kích hoạt Sortable
            $("#sortable-playlist").sortable({
                handle: ".drag-handle",
                axis: "y",
                cursor: "grabbing",
                opacity: 0.9,
                helper: function(e, ui) {
                    // Giữ chiều rộng các cột khi kéo (ngăn vỡ layout bảng)
                    ui.children().each(function() {
                        $(this).width($(this).width());
                    });
                    return ui;
                },
                update: function(event, ui) {
                    // 1. Cập nhật lại số thứ tự hiển thị ngay lập tức
                    updateRowIndices();
                    // 2. Gửi dữ liệu về server
                    saveNewOrder();
                }
            }).disableSelection();
        });

        // Hàm cập nhật lại số STT (1, 2, 3...) trên giao diện
        function updateRowIndices() {
            $('#sortable-playlist tr').each(function(index) {
                $(this).find('.stt-index').text(index + 1);
            });
        }

        function saveNewOrder() {
            var playlistId = @Model.MaPlaylist;
            var songIds = [];

            $("#sortable-playlist tr").each(function() {
                var id = $(this).data("song-id");
                songIds.push(id);
            });

            // Gửi Ajax cập nhật thứ tự
            $.ajax({
                url: '/Playlist/UpdateOrder',
                type: 'POST',
                traditional: true, // Quan trọng để gửi mảng
                data: { playlistId: playlistId, songIds: songIds },
                success: function(res) {
                    console.log("Đã lưu thứ tự mới");
                },
                error: function(err) {
                    console.error("Lỗi khi lưu thứ tự");
                }
            });
        }

        function removeSong(plId, songId) {
            if(!confirm("Bạn có chắc muốn xóa bài hát này khỏi playlist?")) return;

            $.ajax({
                url: '/Playlist/RemoveSong',
                type: 'POST',
                data: { playlistId: plId, songId: songId },
                success: function(res) {
                    if(res.success) {
                        // Hiệu ứng xóa dòng
                        $('#row-' + songId).fadeOut(300, function() {
                            $(this).remove();
                            // Sau khi xóa xong thì đánh lại số thứ tự
                            updateRowIndices();
                        });
                    }
                    else {
                        alert("Lỗi: " + res.msg);
                    }
                }
            });
        }
    </script>
}