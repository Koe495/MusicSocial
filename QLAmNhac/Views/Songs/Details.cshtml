@model QLAmNhac.Models.BaiHat

@{
    ViewBag.Title = Model.TenBaiHat;
    Layout = "~/Views/Shared/_Layout.cshtml";
    var tags = ViewBag.TagList as List<QLAmNhac.Controllers.TagViewModel>;
    var currentUser = Session["User"] as QLAmNhac.Models.NguoiDung;
    int currentUserId = currentUser != null ? currentUser.MaNguoiDung : 0;
    var comments = Model.BinhLuans.OrderByDescending(c => c.NgayBinhLuan).ToList();
}

@functions {
    public string GetYoutubeID(string url)
    {
        if (string.IsNullOrEmpty(url)) return "";
        url = url.Trim();
        if (url.Contains("/embed/"))
        {
            var segments = url.Split(new[] { "/embed/" }, StringSplitOptions.None);
            if (segments.Length > 1) return segments[1].Split('?')[0];
        }
        if (url.Contains("v="))
        {
            var index = url.IndexOf("v=");
            var sub = url.Substring(index + 2);
            var ampIndex = sub.IndexOf("&");
            if (ampIndex != -1) return sub.Substring(0, ampIndex);
            return sub;
        }
        if (url.Contains("youtu.be"))
        {
            var segments = url.Split('/');
            return segments[segments.Length - 1].Split('?')[0];
        }
        return url;
    }
}

<div class="container mt-4">
    <div class="row">
        <!-- Cột TRÁI -->
        <div class="col-md-8">
            <div class="video-container">
                <iframe src="https://www.youtube.com/embed/@GetYoutubeID(Model.LinkYoutube)?autoplay=0&rel=0" frameborder="0" allowfullscreen></iframe>
            </div>
            <h1 class="song-title">@Model.TenBaiHat</h1>
            <p class="song-artist">
                <i class="fa fa-microphone"></i> Trình bày: <strong>@Model.NguoiTrinhBay</strong> |
                <i class="fa fa-user"></i> Đăng bởi: @(Model.NguoiDung != null ? Model.NguoiDung.TenDangNhap : "Ẩn danh")
            </p>

            <!-- Nút Thêm vào Playlist -->
            <button class="btn btn-xs btn-default" style="margin-right: 10px; border: 1px solid #555; background: transparent; color: #ddd; border-radius: 20px;" onclick="openPlaylistModal()">
                <i class="fa fa-plus"></i> Vào Playlist
            </button>
            <hr style="border-color: #404040;" />

            <!-- Tag Cloud -->
            <div class="d-flex justify-content-between align-items-center">
                <h4><i class="fa fa-tags"></i> Cộng đồng gắn thẻ</h4>
                <div>
                    <button class="btn-add-tag" data-toggle="modal" data-target="#addTagModal">
                        <i class="fa fa-plus"></i> Thêm Tag khác
                    </button>
                </div>
            </div>

            <div class="tag-cloud">
                @if (tags != null && tags.Count > 0)
                {
                    foreach (var tag in tags)
                    {
                        <div id="tag-chip-@tag.TagId" class="tag-chip @(tag.IsVotedByMe ? "voted-tag" : "")" style="display:inline-block; margin:4px;">
                            <span class="tag-name">#@tag.TagName</span>
                            <span class="tag-score" id="score-@tag.TagId">@tag.Score</span>

                            <button class="btn-vote" onclick="voteTag(@Model.MaBaiHat, @tag.TagId, this)">
                                <i class="fa fa-caret-up"></i>
                            </button>

                            @* If current user is Admin show remove-tag control *@
                            @if (currentUser != null && currentUser.PhanQuyen == 2)
                            {
                                <button class="btn btn-xs btn-danger" style="margin-left:8px; vertical-align: middle; padding:3px 6px;" title="Xóa tag" onclick="adminDeleteTag(@Model.MaBaiHat, @tag.TagId)">
                                    <i class="fa fa-times"></i>
                                </button>
                            }
                        </div>
                    }
                }
                else
                { <p class="text-muted"></p>}
            </div>

            <!-- BÌNH LUẬN -->
            <div class="mt-5" style="margin-top: 40px;">
                <h4 style="border-bottom: 2px solid #1db954; display: inline-block; padding-bottom: 5px;">
                    <i class="fa fa-comments"></i> Bình luận (<span id="commentCount">@comments.Count</span>)
                </h4>
                <div class="comment-box" style="background: #282828; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <textarea id="txtComment" class="form-control" style="background: #181818; color: #fff; border: 1px solid #444;" rows="2" placeholder="Chia sẻ cảm nghĩ của bạn..."></textarea>
                    <div class="text-right" style="margin-top: 10px;">
                        <button id="btnSubmitComment" class="btn btn-success btn-sm" onclick="submitComment()">Gửi bình luận</button>
                    </div>
                </div>
                <div id="commentList" style="margin-top: 20px;">
                    @foreach (var c in comments)
                    {
                        int upvotes = c.BinhLuanVotes.Count(v => v.IsUpvote == true);
                        int downvotes = c.BinhLuanVotes.Count(v => v.IsUpvote == false);
                        int score = upvotes - downvotes;
                        var myVote = c.BinhLuanVotes.FirstOrDefault(v => v.MaNguoiDung == currentUserId);
                        bool isUpvotedByMe = (myVote != null && myVote.IsUpvote == true);
                        bool isDownvotedByMe = (myVote != null && myVote.IsUpvote == false);

                        <div class="media" id="cmt-row-@c.MaBinhLuan">
                            <div class="media-left"><img src="https://ui-avatars.com/api/?name=@c.NguoiDung.HoTen&background=random" class="media-object img-circle" style="width:45px"></div>
                            <div class="media-body">
                                @if (currentUserId == c.MaNguoiDung || (currentUser != null && currentUser.PhanQuyen == 2))
                                {
                                    <div class="dropdown more-actions-container">
                                        <button class="btn-more-options dropdown-toggle" type="button" data-toggle="dropdown"><i class="fa fa-ellipsis-v"></i></button>
                                        <ul class="dropdown-menu custom-dropdown-menu">
                                            <li><a onclick="showEditForm(@c.MaBinhLuan)"><i class="fa fa-pencil-alt"></i> Chỉnh sửa</a></li>
                                            <li role="separator" class="divider" style="background-color: #444; margin: 0;"></li>
                                            <li><a onclick="deleteComment(@c.MaBinhLuan)" style="color: #d9534f;"><i class="fa fa-trash"></i> Xóa</a></li>
                                        </ul>
                                    </div>
                                }
                                <h5 class="media-heading" style="color: #1db954; font-weight: bold;">@c.NguoiDung.HoTen <small style="color: #777;"> - @(c.NgayBinhLuan.HasValue ? c.NgayBinhLuan.Value.ToString("dd/MM/yyyy HH:mm") : "")</small></h5>
                                <p id="cmt-content-@c.MaBinhLuan" style="color: #ddd;">@c.NoiDung</p>
                                <div id="cmt-edit-form-@c.MaBinhLuan" style="display: none; margin-top: 10px;">
                                    <textarea id="cmt-edit-txt-@c.MaBinhLuan" class="form-control" style="background: #111; color: #fff; margin-bottom: 5px;">@c.NoiDung</textarea>
                                    <div style="text-align: right;"><button class="btn btn-xs btn-custom-save" onclick="saveEditComment(@c.MaBinhLuan)"><i class="fa fa-check"></i> Lưu</button><button class="btn btn-xs btn-custom-cancel" onclick="cancelEditComment(@c.MaBinhLuan)"><i class="fa fa-times"></i> Hủy</button></div>
                                </div>
                                <div class="cmt-actions">
                                    <button id="btn-up-@c.MaBinhLuan" class="cmt-btn @(isUpvotedByMe ? "voted-up" : "")" title="Hay" onclick="voteComment(@c.MaBinhLuan, true)"><i class="fa fa-thumbs-up"></i></button>
                                    <span class="cmt-score" id="cmt-score-@c.MaBinhLuan">@score</span>
                                    <button id="btn-down-@c.MaBinhLuan" class="cmt-btn @(isDownvotedByMe ? "voted-down" : "")" title="Dở" onclick="voteComment(@c.MaBinhLuan, false)"><i class="fa fa-thumbs-down"></i></button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- GỢI Ý BÀI HÁT -->
        <div class="col-md-4">
            <div class="sidebar-box suggestion-box">

                <!-- Tiêu đề thay đổi tùy theo ngữ cảnh -->
                @if (ViewBag.CurrentPlaylistId != null)
                {
                    <h5 class="suggestion-title" style="color: #1db954;">
                        <i class="fa fa-list-ul" style="margin-right: 8px;"></i>
                        Đang phát từ: @ViewBag.CurrentPlaylistName
                    </h5>
                }
                else
                {
                    <h5 class="suggestion-title">
                        <i class="fa fa-headphones" style="color: #1db954; margin-right: 8px;"></i>
                        Gợi ý cho bạn
                    </h5>
                }

                <ul class="list-unstyled suggestion-list" id="suggestionList">
                    @if (ViewBag.SuggestedSongs != null)
                    {
                        foreach (var item in (List<QLAmNhac.Models.BaiHat>)ViewBag.SuggestedSongs)
                        {
                            <li class="suggestion-item">
                                <!-- QUAN TRỌNG: Truyền tiếp playlistId vào URL nếu có -->
                                <a href="@Url.Action("Details", "Songs", new { id = item.MaBaiHat, playlistId = ViewBag.CurrentPlaylistId })"
                                   class="d-flex text-decoration-none next-song-link">

                                    <div class="suggestion-img-wrapper">
                                        <!-- Lưu ý: Hàm GetYoutubeID phải có sẵn trong View hoặc Helper -->
                                        <img src="https://img.youtube.com/vi/@GetYoutubeID(item.LinkYoutube)/mqdefault.jpg"
                                             alt="@item.TenBaiHat">
                                        <div class="suggestion-overlay">
                                            <i class="fa fa-play"></i>
                                        </div>
                                    </div>

                                    <div class="suggestion-info">
                                        <h6 class="suggestion-song-name" title="@item.TenBaiHat">@item.TenBaiHat</h6>
                                        <p class="suggestion-artist">@item.NguoiTrinhBay</p>
                                    </div>
                                </a>
                            </li>
                        }
                    }
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Modal Thêm Tag -->
<div id="addTagModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content" style="background-color: #282828; color: white;">
            <div class="modal-header" style="border-bottom: 1px solid #444;"><button type="button" class="close" data-dismiss="modal">&times;</button><h4 class="modal-title">Đóng góp thể loại nhạc</h4></div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom:10px;">
                    <input type="text" id="txtNewTag" class="form-control" placeholder="Tên tag..." style="background: #181818; border: 1px solid #444; color: white;" />
                </div>
                <div>
                    <p class="text-muted" style="margin-bottom:8px;">Hoặc chọn từ tag có sẵn:</p>
                    <div id="tagSuggestions" style="max-height:240px; overflow-y:auto;">
                        <p class="text-center"><i class="fa fa-spinner fa-spin"></i> Đang tải...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid #444;"><button class="btn btn-default" data-dismiss="modal">Hủy</button><button class="btn btn-success" id="btnSaveNewTag">Lưu</button></div>
        </div>
    </div>
</div>

<!-- Modal Chọn Playlist -->
<div id="addToPlaylistModal" class="modal fade" role="dialog">
    <div class="modal-dialog modal-sm">
        <div class="modal-content" style="background-color: #282828; color: white;">
            <div class="modal-header" style="border-bottom: 1px solid #444;">
                <button type="button" class="close" data-dismiss="modal" style="color: white;">&times;</button>
                <h4 class="modal-title">Thêm vào Playlist</h4>
            </div>
            <div class="modal-body">
                <!-- KHU VỰC CÔNG CỤ: TÌM KIẾM & TẠO MỚI -->
                <div class="row" style="margin-bottom: 15px; margin-left: -5px; margin-right: -5px;">
                    <!-- Ô tìm kiếm -->
                    <div class="col-xs-8" id="search-area" style="padding-left: 5px; padding-right: 5px;">
                        <div class="input-group">
                            <span class="input-group-addon" style="background: #222; border-color: #444; color: #888; padding: 0 8px;"><i class="fa fa-search"></i></span>
                            <input type="text" id="txtSearchPlaylist" class="form-control input-sm" placeholder="Tìm playlist..." style="background: #111; border: 1px solid #444; color: white; border-left: none;">
                        </div>
                    </div>
                    <!-- Nút tạo mới -->
                    <div class="col-xs-4" id="btn-create-area" style="padding-left: 5px; padding-right: 5px;">
                        <button class="btn btn-success btn-sm btn-block" onclick="toggleCreateMode(true)" style="background-color: #1db954; border: none;">
                            <i class="fa fa-plus"></i> Mới
                        </button>
                    </div>

                    <!-- Ô tạo playlist mới (Mặc định ẩn) -->
                    <div class="col-xs-12" id="form-create-area" style="display: none; padding-left: 5px; padding-right: 5px;">
                        <div class="input-group">
                            <input type="text" id="txtNewPlaylistName" class="form-control input-sm" placeholder="Nhập tên playlist..." style="background: #111; border: 1px solid #1db954; color: white;">
                            <span class="input-group-btn">
                                <button class="btn btn-success btn-sm" onclick="createNewPlaylist()" title="Lưu"><i class="fa fa-check"></i></button>
                                <button class="btn btn-default btn-sm" onclick="toggleCreateMode(false)" title="Hủy" style="background: #444; color: white; border-color: #444;"><i class="fa fa-times"></i></button>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- DANH SÁCH PLAYLIST -->
                <div id="playlistList" class="list-group" style="margin-bottom: 0; max-height: 300px; overflow-y: auto;">
                    <!-- Danh sách playlist sẽ được nạp bằng Ajax -->
                    <p class="text-center"><i class="fa fa-spinner fa-spin"></i> Đang tải...</p>
                </div>
            </div>
        </div>
    </div>
</div>
@section scripts {
    <script>
        var currentSongId = @Model.MaBaiHat;
        var currentUserId = @currentUserId;

        // --- CÁC HÀM XỬ LÝ TAG & COMMENT---
        function voteTag(songId, tagId, btnElement) {
            $.ajax({
                url: '/Songs/VoteTag', type: 'POST', data: { songId: songId, tagId: tagId },
                success: function(res) {
                    if(res.success) {
                        var scoreSpan = $('#score-' + tagId);
                        var currentScore = parseInt(scoreSpan.text() || "0");
                        var tagChip = $('#tag-chip-' + tagId);
                        if(res.action == 'upvote') { scoreSpan.text(currentScore + 1); tagChip.addClass('voted-tag'); }
                        else { scoreSpan.text(Math.max(0, currentScore - 1)); tagChip.removeClass('voted-tag'); }
                    } else { alert(res.msg); }
                }, error: function() { alert('Lỗi kết nối server!'); }
            });
        }

        // Admin: delete tag association from song
        function adminDeleteTag(songId, tagId) {
            if (!confirm("Bạn chắc chắn muốn xóa thẻ này khỏi bài hát?")) return;

            $.ajax({
                url: '/Admin/DeleteTagFromSong',
                type: 'POST',
                data: { songId: songId, tagId: tagId },
                success: function (res) {
                    if (res && res.success) {
                        $('#tag-chip-' + tagId).fadeOut();
                        $('#suggest-chip-' + tagId).remove();
                        // Optionally show a short success toast
                    } else {
                        alert(res && res.msg ? res.msg : "Xóa thất bại!");
                    }
                },
                error: function (xhr, status, err) {
                    // Try to extract JSON error message from server if available
                    var msg = "Lỗi kết nối server!";
                    try {
                        if (xhr && xhr.responseText) {
                            var json = JSON.parse(xhr.responseText);
                            if (json && json.msg) msg = json.msg;
                        }
                    } catch (e) {
                        // Not JSON - fall back to raw responseText (trim for safety)
                        if (xhr && xhr.responseText) {
                            msg = xhr.responseText.substring(0, 500);
                        }
                    }
                    alert(msg);
                }
            });
        }

        // Load danh sách tag gợi ý khi mở modal
        function loadTagSuggestions() {
            $('#tagSuggestions').html('<p class="text-center"><i class="fa fa-spinner fa-spin"></i> Đang tải...</p>');
            $.ajax({
                url: '/Songs/GetTagSuggestions',
                type: 'POST',
                data: { songId: currentSongId },
                success: function(res) {
                    if (res.success) {
                        renderTagSuggestions(res.data);
                    } else {
                        $('#tagSuggestions').html('<p class="text-danger">Không thể tải tag.</p>');
                    }
                },
                error: function() {
                    $('#tagSuggestions').html('<p class="text-danger">Lỗi kết nối.</p>');
                }
            });
        }

        // Render suggestion chips using the same markup/classes as tag-cloud so styling matches
        function renderTagSuggestions(data) {
            if (!data || data.length === 0) {
                $('#tagSuggestions').html('<p class="text-muted">Không có tag nào trong hệ thống.</p>');
                return;
            }
            var html = '';
            data.forEach(function(t) {
                var votedClass = t.IsVotedByMe ? 'voted-tag' : '';
                // Use identical structure to tag-cloud: .tag-chip, .tag-name, .tag-score, .btn-vote
                html += `<div id="suggest-chip-${t.TagId}" class="tag-chip ${votedClass}" data-tagid="${t.TagId}" style="display:inline-block; margin:4px;">
                            <span class="tag-name">#${t.TagName}</span>
                            <span class="tag-score" id="suggest-score-${t.TagId}">${t.Score}</span>
                            <button class="btn-vote" onclick="submitNewTag(${t.TagId})"><i class="fa fa-caret-up"></i></button>
                         </div>`;
            });
            $('#tagSuggestions').html(html);
        }

        // Thêm Tag mới hoặc chọn Tag có sẵn. Nếu param tagId được truyền thì server sẽ xử lý bằng tagId.
        function submitNewTag(tagId) {
            var data = { songId: currentSongId };
            if (tagId && tagId > 0) {
                data.tagId = tagId;
            } else {
                var name = $('#txtNewTag').val();
                if (!name || name.trim() === '') { alert("Nhập tên tag!"); return; }
                data.tagName = name;
            }

            $.ajax({
                url: '/Songs/AddTag',
                type: 'POST',
                data: data,
                success: function(res) {
                    if (res.success) {
                        $('#addTagModal').modal('hide');
                        if (res.tag) {
                            updateTagCloud(res.tag);
                        } else {
                            location.reload();
                        }
                    } else {
                        if (res.tag) {
                            updateTagCloud(res.tag);
                        }
                        alert(res.msg);
                    }
                },
                error: function() {
                    alert("Lỗi kết nối server khi thêm tag.");
                }
            });
        }

        // Thêm thẻ tag trên tag-cloud mà không reload trang
        function updateTagCloud(tagVm) {
            var id = tagVm.TagId;
            var name = tagVm.TagName;
            var score = tagVm.Score;
            var voted = tagVm.IsVotedByMe;

            var chip = $('#tag-chip-' + id);
            if (chip.length > 0) {
                // Cập nhật điểm và trạng thái voted
                $('#score-' + id).text(score);
                if (voted) chip.addClass('voted-tag'); else chip.removeClass('voted-tag');
            } else {
                // Create markup identical to server-rendered chips (no inline CSS that overrides styles)
                var votedClass = voted ? 'voted-tag' : '';
                var html = '<div id="tag-chip-' + id + '" class="tag-chip ' + votedClass + '">' +
                                '<span class="tag-name">#' + htmlEncode(name) + '</span>' +
                                '<span class="tag-score" id="score-' + id + '">' + score + '</span>' +
                                '<button class="btn-vote" onclick="voteTag(' + currentSongId + ', ' + id + ', this)"><i class="fa fa-caret-up"></i></button>' +
                           '</div>';
                $('.tag-cloud').prepend(html);
            }

            // Also update suggestion box if present
            var suggestScore = $('#suggest-score-' + id);
            if (suggestScore.length > 0) suggestScore.text(score);

            // If a suggestion chip exists, update its voted appearance too
            var suggestChip = $('#suggest-chip-' + id);
            if (suggestChip.length > 0) {
                if (voted) suggestChip.addClass('voted-tag'); else suggestChip.removeClass('voted-tag');
                $('#suggest-score-' + id).text(score);
            }
        }

        // Small helper to avoid XSS when inserting tag names
        function htmlEncode(str) {
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function voteComment(id, isUp) {
            $.ajax({ url: '/Songs/VoteComment', type: 'POST', data: { commentId: id, isUpvote: isUp },
                success: function(res) {
                    if(res.success) {
                        $('#cmt-score-' + id).text(res.score);
                        var btnUp = $('#btn-up-' + id); var btnDown = $('#btn-down-' + id);
                        if (isUp) { if (btnUp.hasClass('voted-up')) { btnUp.removeClass('voted-up'); } else { btnUp.addClass('voted-up'); btnDown.removeClass('voted-down'); } }
                        else { if (btnDown.hasClass('voted-down')) { btnDown.removeClass('voted-down'); } else { btnDown.addClass('voted-down'); btnUp.removeClass('voted-up'); } }
                    } else alert(res.msg);
                }
            });
        }
        function deleteComment(id) { if(!confirm("Bạn có chắc muốn xóa?")) return; $.ajax({ url: '/Songs/DeleteComment', type: 'POST', data: { id: id }, success: function(res) { if(res.success) $('#cmt-row-' + id).slideUp(); else alert(res.msg); } }); }
        function showEditForm(id) { $('#cmt-content-'+id).hide(); $('#cmt-edit-form-'+id).slideDown(); }
        function cancelEditComment(id) { $('#cmt-edit-form-'+id).hide(); $('#cmt-content-'+id).show(); }
        function saveEditComment(id) { var c = $('#cmt-edit-txt-' + id).val(); $.ajax({ url: '/Songs/EditComment', type: 'POST', data: { id: id, content: c }, success: function(r) { if(r.success){ $('#cmt-content-'+id).text(c).show(); $('#cmt-edit-form-'+id).hide(); } else alert(r.msg); } }); }

        // Ajax submit comment — does not reload page (keeps music playing)
        function submitComment() {
            var $btn = $('#btnSubmitComment');
            var content = $('#txtComment').val();
            if (content.trim() == "") { alert("Nhập nội dung!"); return; }

            $btn.prop('disabled', true).text('Đang gửi...');

            $.ajax({
                url: '/Songs/AddComment',
                type: 'POST',
                data: { songId: currentSongId, content: content },
                success: function (r) {
                    if (r.success) {
                        // Build comment markup and prepend to the list (matches server markup)
                        var id = r.id;
                        var author = r.author || "Bạn";
                        var time = r.time || "";
                        var escapedContent = htmlEncode(r.content || content);

                        var dropdownHtml = '<div class="dropdown more-actions-container">' +
                                            '<button class="btn-more-options dropdown-toggle" type="button" data-toggle="dropdown"><i class="fa fa-ellipsis-v"></i></button>' +
                                            '<ul class="dropdown-menu custom-dropdown-menu">' +
                                                '<li><a onclick="showEditForm(' + id + ')"><i class="fa fa-pencil-alt"></i> Chỉnh sửa</a></li>' +
                                                '<li role="separator" class="divider" style="background-color: #444; margin: 0;"></li>' +
                                                '<li><a onclick="deleteComment(' + id + ')" style="color: #d9534f;"><i class="fa fa-trash"></i> Xóa</a></li>' +
                                            '</ul>' +
                                          '</div>';

                        var mediaHtml = '<div class="media" id="cmt-row-' + id + '">' +
                                            '<div class="media-left"><img src="https://ui-avatars.com/api/?name=' + encodeURIComponent(author) + '&background=random" class="media-object img-circle" style="width:45px"></div>' +
                                            '<div class="media-body">';
                        // current user is the author, so show owner actions
                        mediaHtml += dropdownHtml;
                        mediaHtml += '<h5 class="media-heading" style="color: #1db954; font-weight: bold;">' + htmlEncode(author) + ' <small style="color: #777;"> - ' + htmlEncode(time) + '</small></h5>' +
                                     '<p id="cmt-content-' + id + '" style="color: #ddd;">' + escapedContent + '</p>' +
                                     '<div id="cmt-edit-form-' + id + '" style="display: none; margin-top: 10px;">' +
                                         '<textarea id="cmt-edit-txt-' + id + '" class="form-control" style="background: #111; color: #fff; margin-bottom: 5px;">' + escapedContent + '</textarea>' +
                                         '<div style="text-align: right;"><button class="btn btn-xs btn-custom-save" onclick="saveEditComment(' + id + ')"><i class="fa fa-check"></i> Lưu</button><button class="btn btn-xs btn-custom-cancel" onclick="cancelEditComment(' + id + ')"><i class="fa fa-times"></i> Hủy</button></div>' +
                                     '</div>' +
                                     '<div class="cmt-actions">' +
                                         '<button id="btn-up-' + id + '" class="cmt-btn" title="Hay" onclick="voteComment(' + id + ', true)"><i class="fa fa-thumbs-up"></i></button>' +
                                         '<span class="cmt-score" id="cmt-score-' + id + '">0</span>' +
                                         '<button id="btn-down-' + id + '" class="cmt-btn" title="Dở" onclick="voteComment(' + id + ', false)"><i class="fa fa-thumbs-down"></i></button>' +
                                     '</div>' +
                                 '</div></div>';

                        $('#commentList').prepend(mediaHtml);

                        // Clear input, increment counter
                        $('#txtComment').val('');
                        var $count = $('#commentCount');
                        var cur = parseInt($count.text() || "0");
                        $count.text(cur + 1);

                        // Optionally scroll to the new comment or flash it
                        $('#cmt-row-' + id).hide().slideDown();

                    } else {
                        alert(r.msg || "Gửi bình luận thất bại!");
                    }
                },
                error: function () {
                    alert("Lỗi kết nối server!");
                },
                complete: function () {
                    $btn.prop('disabled', false).text('Gửi bình luận');
                }
            });
        }

        // Gắn handler khi modal mở để load gợi ý tag
        $('#addTagModal').on('show.bs.modal', function () {
            $('#txtNewTag').val('');
            loadTagSuggestions();
        });

        // Nút Lưu trong modal (nhập tag thủ công)
        $('#btnSaveNewTag').on('click', function() {
            submitNewTag();
        });

        // --- LOGIC PLAYLIST ---

        // 1. Mở modal và load danh sách
        function openPlaylistModal() {
            $('#addToPlaylistModal').modal('show');
            // Reset giao diện: Ẩn form tạo, hiện tìm kiếm, xóa text tìm kiếm
            toggleCreateMode(false);
            $('#txtSearchPlaylist').val('');
            loadPlaylists();
        }

        function loadPlaylists() {
            $('#playlistList').html('<p class="text-center" style="margin-top:10px;"><i class="fa fa-spinner fa-spin"></i> Đang tải...</p>');
            $.ajax({
                url: '/Playlist/GetMyPlaylists', type: 'POST',
                success: function(res) {
                    if(res.success) {
                        renderPlaylistItems(res.data);
                    } else {
                        // Nếu chưa đăng nhập
                        $('#playlistList').html('<p class="text-center text-danger" style="padding:10px;">Bạn cần đăng nhập!</p>');
                        if(confirm("Bạn cần đăng nhập để sử dụng tính năng này. Đi tới đăng nhập?")) window.location.href = '/Account/Login';
                    }
                }
            });
        }

        // Render HTML danh sách playlist
        function renderPlaylistItems(data) {
            var html = '';
            if(data.length == 0) {
                html = '<p class="text-muted text-center" style="margin-top:20px;">Bạn chưa có playlist nào.</p>';
            } else {
                data.forEach(function(pl) {
                    html += `<button type="button" class="list-group-item playlist-item" style="background: #111; color: #ddd; border: 1px solid #333; margin-bottom: -1px;" onclick="addSongToPlaylist(${pl.MaPlaylist})">
                                <span class="badge" style="background:#333;">${pl.SoLuong}</span>
                                <span class="pl-name">${pl.TenPlaylist}</span>
                             </button>`;
                });
            }
            $('#playlistList').html(html);
        }

        // 2. Xử lý Tìm kiếm Playlist (Client-side)
        $('#txtSearchPlaylist').on('keyup', function() {
            var value = $(this).val().toLowerCase();
            $("#playlistList .playlist-item").filter(function() {
                // Toggle hiện/ẩn dựa trên text
                $(this).toggle($(this).find('.pl-name').text().toLowerCase().indexOf(value) > -1)
            });
        });

        // 3. Chuyển đổi giữa chế độ Xem và Tạo mới
        function toggleCreateMode(isCreate) {
            if(isCreate) {
                $('#search-area').hide();
                $('#btn-create-area').hide();
                $('#form-create-area').fadeIn();
                $('#txtNewPlaylistName').focus();
            } else {
                $('#form-create-area').hide();
                $('#search-area').fadeIn();
                $('#btn-create-area').fadeIn();
                $('#txtNewPlaylistName').val(''); // Xóa text đã nhập
            }
        }

        // 4. Tạo Playlist Mới (Ajax)
        function createNewPlaylist() {
            var name = $('#txtNewPlaylistName').val();
            if(!name || name.trim() === '') {
                alert("Vui lòng nhập tên playlist!");
                return;
            }

            $.ajax({
                url: '/Playlist/CreateAjax', // Đảm bảo bạn có Action này trong PlaylistController
                type: 'POST',
                data: { tenPlaylist: name },
                success: function(res) {
                    if(res.success) {
                        // Tải lại danh sách để thấy playlist mới
                        loadPlaylists();
                        // Quay về chế độ xem
                        toggleCreateMode(false);
                    } else {
                        alert(res.msg);
                    }
                },
                error: function() {
                    alert("Lỗi kết nối khi tạo playlist.");
                }
            });
        }

        // 5. Thêm bài hát vào Playlist
        function addSongToPlaylist(plId) {
            var songId = @Model.MaBaiHat;
            $.ajax({
                url: '/Playlist/AddSong', type: 'POST',
                data: { playlistId: plId, songId: songId },
                success: function(res) {
                    alert(res.msg); // Thông báo kết quả
                    if(res.success) $('#addToPlaylistModal').modal('hide');
                }
            });
        }

        // LOGIC
    </script>
}